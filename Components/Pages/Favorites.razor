@* Steven Baar *@
@* 12/18/26 *@
@* Currency Converter *@
@* This page is used to display the stored favorites for the user *@

@page "/favorites"
@rendermode InteractiveServer
@using System.Text
@using System.Text.Json
@using currency_converter_cs.Components.Clients
@using currency_converter_cs.Components.Models
@using currency_converter_cs.Components.Utils
@inject ExchangeRateService ExchangeRateService
@inject FavoritesService FavoritesService
@inject IJSRuntime Js

<PageTitle>Favorites</PageTitle>

<!-- JavaScript for handling file downloads (Same as Home.razor) -->
<script>
    // Creates a globally accessible JS function
    window.downloadCsv = (filename, content) => {
        // Creates an anchor element in memory
        const element = document.createElement('a');
        // Construct data link from the formatted table
        element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(content));
        // Download resource through the constructed link instead of navigating to it
        element.setAttribute('download', filename);
        // Force a simulated "click" on our temporary anchor element we created
        document.body.appendChild(element);
        element.click();
        // Free the resource from memory after download has started
        document.body.removeChild(element);
    };
</script>

<h1>My Favorites</h1>

<div class="d-flex justify-content-between align-items-center mb-3">

    <div class="d-flex gap-2">
        <!-- Export Button -->
        <button class="btn btn-success" @onclick="ExportTable" disabled="@(_tableRows.Count == 0)">
            Export CSV
        </button>

        <!-- Manual Refresh Button -->
        <button class="btn btn-primary" @onclick="FavoritesService.LoadFavoritesData">
            Refresh Rates
        </button>
    </div>
</div>

@if (_isLoading)
{
    <p><em>Loading favorite rates...</em></p>
}
else if (_tableRows.Count == 0)
{
    <div class="alert alert-info">
        Your favorites are empty. Go to <a href="/">Home</a> to add some currency pairs!
    </div>
}
else
{
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>From</th>
                <th>To</th>
                <th>Latest Rate</th>
                <th>Date</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var row in _tableRows)
            {
                <tr>
                    <td><strong>@row.From.ToUpper()</strong></td>
                    <td>@row.To.ToUpper()</td>
                    <td>@row.Rate</td>
                    <td>@row.Date</td>
                    <td>
                        <button class="btn btn-danger btn-sm"
                                @onclick="() => FavoritesService.RemoveFavorite(row.From, row.To)">
                            Remove
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<ConversionRow> _tableRows = new();
    private bool _isLoading = true;


    protected override async Task OnInitializedAsync()
    {
        _tableRows.Clear();
        _tableRows = await FavoritesService.LoadFavoritesData();
        _isLoading = false;
    }

    private async Task ExportTable()
    {
        // Define the filename
        var fileName = $"favorites-{DateTime.Now:yyyy.M.d}.csv";

        // Format the current table to CSV
        var csvString = await CsvUtil.FormatTableToCsv(_tableRows);

        // Call JavaScript to trigger the download
        await Js.InvokeVoidAsync("downloadCsv", fileName, csvString);
    }
}
@page "/"
@rendermode InteractiveServer
@using System.Text
@using System.Text.Json
@using currency_converter_cs.Components.Clients
@using currency_converter_cs.Components.Models
@using currency_converter_cs.Components.Utils
@inject FavoritesService Favorites
@inject ExchangeRateService ExchangeRateService
@inject IJSRuntime Js

<PageTitle>Home</PageTitle>

<!-- JavaScript for handling file downloads -->
<script>
    // Creates a globally accessible JS function
    window.downloadCsv = (filename, content) => {
        // Creates an anchor element in memory
        const element = document.createElement('a');
        // Construct data link from the formatted table
        element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(content));
        // Download resource through the constructed link instead of navigating to it
        element.setAttribute('download', filename);
        // Force a simulated "click" on our temporary anchor element we created
        document.body.appendChild(element);
        element.click();
        // Free the resource from memory after download has started
        document.body.removeChild(element);
    };
</script>

<h1>Daily Currency Conversion Rates</h1>

@if (_allCurrencies is null || !_allCurrencies.Any())
{
    <p>No results available.</p>
}
else
{
    <!-- Updated Layout with Labels and Export Button -->
    <div class="filters d-flex align-items-end gap-3 mb-3">

        <!-- FROM Group dropdown -->
        <div>
            <label class="form-label fw-bold mb-1">From</label>
            <select @bind="_selectedFrom" @bind:after="LoadTableData" class="form-select" style="min-width: 100px;">
                @foreach (var currency in _allCurrencies)
                {
                    <option value="@currency">@currency.ToUpper()</option>
                }
            </select>
        </div>

        <!-- TO Group dropdown -->
        <div>
            <label class="form-label fw-bold mb-1">To</label>
            <select @bind="_selectedTo" @bind:after="LoadTableData" class="form-select" style="min-width: 100px;">
                <option value="*">*</option>
                @foreach (var currency in _allCurrencies)
                {
                    <option value="@currency">@currency.ToUpper()</option>
                }
            </select>
        </div>

        <!-- Export Button -->
        <button class="btn btn-success" @onclick="ExportTable" disabled="@(_tableRows.Count == 0)">
            Export CSV
        </button>
    </div>

    @if (_tableRows.Count == 0)
    {
        <p>Loading data...</p>
    }
    else
    {
        <table class="table table-striped table-bordered align-middle">
            <thead>
                <tr>
                    <th>From</th>
                    <th>To</th>
                    <th>Rate</th>
                    <th>Date</th>
                    <th style="text-align: center;">Favorite</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var row in _tableRows)
                {
                    <tr>
                        <td>@row.From.ToUpper()</td>
                        <td>@row.To.ToUpper()</td>
                        <td>@row.Rate</td>
                        <td>@row.Date</td>
                        <td style="text-align: center;">
                            <button class="btn btn-link p-0 text-decoration-none" style="font-size: 1.2rem;"
                                    @onclick="() => Favorites.AddFavorite(row.From, row.To)">
                                ❤️
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}


@code {
    private List<string> _allCurrencies;
    private readonly List<ConversionRow> _tableRows = new();

    private string _selectedFrom = "usd";
    private string _selectedTo = "*";

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("=== Initializing Home ===");

        var data = await ExchangeRateService.GetRatesAsync("usd");



        if (data != null)
        {
            var baseCurrency = data.Rates.Keys.First();
            Console.WriteLine($"[INFO] Base currency: {baseCurrency}");
            var dict = data.Rates[baseCurrency].Deserialize<Dictionary<string, decimal>>();

            if (dict != null)
            {
                _allCurrencies = dict.Keys.OrderBy(x => x).ToList();
                Console.WriteLine($"[INFO] All currencies: {_allCurrencies.First()}");
            }
        }

        await LoadTableData();
    }

    private async Task LoadTableData()
    {
        Console.WriteLine("=== LoadTableData CALLED ===");
        Console.WriteLine($"SelectedFrom = {_selectedFrom}, SelectedTo = {_selectedTo}");

        _tableRows.Clear();

        var data = await ExchangeRateService.GetRatesAsync(_selectedFrom);

        if (data == null)
        {
            Console.WriteLine("GetRatesAsync returned NULL");
            return;
        }

        if (!data.Rates.TryGetValue(_selectedFrom, out var rateElement))
        {
            Console.WriteLine("SelectedFrom not found in dataset");
            return;
        }

        var dict = JsonSerializer.Deserialize<Dictionary<string, decimal>>(rateElement);

        Console.WriteLine(dict);

        if (dict == null)
        {
            Console.WriteLine("[Error] Returned list is null");
            return;
        }

        if (_selectedTo == "*")
        {
            foreach (var kvp in dict)
            {
                _tableRows.Add(new ConversionRow
                {
                    From = _selectedFrom,
                    To = kvp.Key,
                    Rate = kvp.Value,
                    Date = data.Date
                });
            }
        }
        else if (dict.TryGetValue(_selectedTo, out var rate))
        {
            _tableRows.Add(new ConversionRow
            {
                From = _selectedFrom,
                To = _selectedTo,
                Rate = rate,
                Date = data.Date
            });
        }

        Console.WriteLine($"FINAL ROW COUNT: {_tableRows.Count}");
        StateHasChanged();
    }

    private async Task ExportTable()
    {
        var fileName = "";

        // Define the filename
        if (_selectedTo == "*")
        {
            fileName = $"{_selectedFrom}-{DateTime.Now:yyyy.M.d}.csv";
        }
        else
        {
            fileName = $"{_selectedFrom}-to-{_selectedTo}-{DateTime.Now:yyyy.M.d}.csv";
        }

        // Format current table to CSV
        var csvString = await CsvUtil.FormatTableToCsv(_tableRows);

        // Call our globally accessible JS function "downloadCsv" to trigger the download
        await Js.InvokeVoidAsync("downloadCsv", fileName, csvString);
    }


}